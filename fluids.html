<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>Elastic Sphere</title>
<style>
body, html {
  margin: 0px;
  width: 100%;
  height: 100%;
  background-color: rgb(85,85,85);
}
#example {
  width: 512px;
  height: 512px;
}
#loading {
  color: white;
  position:absolute;
  top: 10px;
  left: 10px;
}
#controls {
  color: white;
  position: absolute;
  top: 10px;
  left: 610px;
  width: 300px;
}
#text {
  color: white;
  position: absolute;
  top: 610px;
  left: 10px;
  width: 910px;
}
</style>
<script id="shader-vs" type="x-shader/x-vertex"> 
  precision mediump float;
  attribute vec2 aTexCoord;
  uniform float speed;
  varying vec2 texCoord;
void main()
    {
	gl_Position = vec4(aTexCoord, 0., 1.);
	texCoord = vec2((aTexCoord.x+1.)/2., (aTexCoord.y+1.)/2.);
    }
</script> 

<script id="shader-fs" type="x-shader/x-fragment"> 
precision mediump                    float;		
uniform sampler2D samp;
uniform float speed;
const float spacing = 1./512.;
varying vec2 texCoord;
void main(void) {
   vec4 left = texture2D(samp, texCoord+vec2(-spacing,0.));
   vec4 right = texture2D(samp, texCoord+vec2(spacing,0.));
   vec4 up = texture2D(samp, texCoord+vec2(0.,spacing));
   vec4 down = texture2D(samp, texCoord+vec2(0.,-spacing));
   vec4 current = texture2D(samp, texCoord);
   float uxX = (right.x-left.x)/2.;
   float uyY = (up.y-down.y)/2.;
   float uxY = (right.y-left.y)/2.;
   float uyX = (up.x-down.x)/2.;
   vec4 lapl = left+right+up+down-4.*current;
   gl_FragColor = vec4(
		current.x+0.2*(2.*(-uxX*current.x-uxY*current.y)+0.5*lapl.x),
		current.y+0.2*(2.*(-uyY*current.y-uyX*current.x)+0.5*lapl.y),
		0.,1.);
}
</script> 

<script id="shader-vs-pic" type="x-shader/x-vertex"> 
  precision mediump float;
  attribute vec2 aTexCoord;
  varying vec2 texCoord;
void main()
    {
	gl_Position = vec4(aTexCoord, 0., 1.);
	texCoord = vec2((aTexCoord.x+1.)/2., (aTexCoord.y+1.)/2.);
    }
</script> 

<script id="shader-fs-pic" type="x-shader/x-fragment"> 
precision mediump float;
		
uniform sampler2D samp;
uniform sampler2D picsamp;
const float spacing = 1./512.;
varying vec2 texCoord;

void main(void) {
   gl_FragColor = (texture2D(picsamp, texCoord-texture2D(samp,texCoord).xy/256.)+texture2D(picsamp, texCoord))/2.;
}
</script> 
 
<script id="shader-vs-show" type="x-shader/x-vertex"> 
precision mediump float;
    attribute vec2 vp;
    varying vec2 texCoord;

    void main()
    {
	gl_Position = vec4(vp, 0., 1.);
	texCoord = vec2((vp.x+1.)/2., (vp.y+1.)/2.);
    }
</script> 
 
<script id="shader-fs-show" type="x-shader/x-fragment"> 
precision mediump float;
    varying vec2 texCoord;
    uniform sampler2D samp;

    void main()
    {
	gl_FragColor = texture2D(samp, texCoord);
    }
</script> 

<script>
var gl;

    function getShader(gl, id) {
        var shaderScript = document.getElementById(id);
        if (!shaderScript) {
            return null;
        }

        var str = "";
        var k = shaderScript.firstChild;
        while (k) {
            if (k.nodeType == 3) {
                str += k.textContent;
            }
            k = k.nextSibling;
        }

        var shader;
        if (shaderScript.type == "x-shader/x-fragment") {
            shader = gl.createShader(gl.FRAGMENT_SHADER);
        } else if (shaderScript.type == "x-shader/x-vertex") {
            shader = gl.createShader(gl.VERTEX_SHADER);
        } else {
            return null;
        }

        gl.shaderSource(shader, str);
        gl.compileShader(shader);

        if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {
            alert(gl.getShaderInfoLog(shader));
            return null;
        }

        return shader;
    }

    var err = "Your browser does not support ";

   var gl, canvas,
    prog, prog_show, prog_pic, texture, texture1, FBO, FBO1, samp, samp1_pic, samp2_pic, samp_show,
    pictexture1, pictexture, picFBO, picFBO1, m = 512, invisibleCanvas, currentSamp = 1;
 
   var pix = new Float32Array(3*m*m);

   function initShaders() {
	
	var ext = gl.getExtension("OES_texture_float");
   	if ( !ext ) {alert(err + "OES_texture_float extension"); return;}
	
        prog_show  = gl.createProgram();
	gl.bindAttribLocation(prog_show, 0, "aTexCoord");
        gl.attachShader(prog_show, getShader( gl, "shader-vs-show" ));
        gl.attachShader(prog_show, getShader( gl, "shader-fs-show" ));
        gl.linkProgram(prog_show);

        gl.useProgram(prog_show);
	samp_show = gl.getUniformLocation(prog_show, "samp");
	gl.enableVertexAttribArray(0);
	var trianglepts = [-1,-1,-1,1,1,1,1,-1];
	gl.bindBuffer(gl.ARRAY_BUFFER, gl.createBuffer());
	gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(trianglepts), gl.STATIC_DRAW);
        gl.vertexAttribPointer(0, 2, gl.FLOAT, false, 0, 0);

        prog = gl.createProgram();
	gl.bindAttribLocation(prog, 0, "vp");
	gl.attachShader(prog, getShader(gl, "shader-vs"));
	gl.attachShader(prog, getShader(gl, "shader-fs"));
	gl.linkProgram(prog);

	samp = gl.getUniformLocation(prog, "samp");
	gl.speedUniform = gl.getUniformLocation(prog, "speed");
	gl.uniform1f(gl.speedUniform,0.5);

	prog_pic = gl.createProgram();
	gl.bindAttribLocation(prog_pic, 0, "aTexCoord");
	gl.attachShader(prog_pic, getShader(gl, "shader-vs-pic"));
	gl.attachShader(prog_pic, getShader(gl, "shader-fs-pic"));
	gl.linkProgram(prog_pic);

	samp1_pic = gl.getUniformLocation(prog_pic, "samp");
	samp2_pic = gl.getUniformLocation(prog_pic, "picsamp");
   
   	texture1 = gl.createTexture();
   	texture = gl.createTexture();
   	FBO = gl.createFramebuffer();
   	FBO1 = gl.createFramebuffer();

	pictexture = gl.createTexture();
	pictexture1 = gl.createTexture();
	picFBO = gl.createFramebuffer();
	picFBO1 = gl.createFramebuffer();

	loadInitialValues();
    }

    function loadInitialValues() {
	for (x = 0; x < m; x++) {
		for (y = 0; y < m; y++) {
			if ((x-m/2)*(x-m/2)+(y-m/2)*(y-m/2) < 40*40) {
			pix[3*(x*m+y)] = 
			Math.sqrt(40*40-(x-m/2)*(x-m/2)-(y-m/2)*(y-m/2))*(m/2-x)/40/40;
			pix[3*(x*m+y)+1] = 
			Math.sqrt(40*40-(x-m/2)*(x-m/2)-(y-m/2)*(y-m/2))*(y-m/2)/40/40;
			}
		}
	}
        gl.activeTexture(gl.TEXTURE1);
        gl.bindTexture(gl.TEXTURE_2D, texture1);
        gl.pixelStorei(gl.UNPACK_ALIGNMENT, 1);
        gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGB, m, m, 0,
        gl.RGB, gl.FLOAT, pix);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);
        gl.activeTexture(gl.TEXTURE0);
        gl.bindTexture(gl.TEXTURE_2D, texture);
        gl.pixelStorei(gl.UNPACK_ALIGNMENT, 1);
        gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGB, m, m, 0,
        gl.RGB, gl.FLOAT, pix);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);
        gl.bindFramebuffer(gl.FRAMEBUFFER, FBO);
        gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0,
        gl.TEXTURE_2D, texture, 0);
        gl.bindFramebuffer(gl.FRAMEBUFFER, FBO1);
        gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0,
        gl.TEXTURE_2D, texture1, 0);
        if( gl.checkFramebufferStatus(gl.FRAMEBUFFER) != gl.FRAMEBUFFER_COMPLETE)
        alert(err + "FLOAT as the color attachment to an FBO");
    }
		
    function drawScene() {
        gl.bindFramebuffer(gl.FRAMEBUFFER, null);   
        gl.viewport(0, 0, gl.drawingBufferWidth, gl.drawingBufferHeight);
        gl.useProgram(prog_show);
	gl.uniform1i(samp_show, currentSamp+2);
        gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);

        gl.enable(gl.DEPTH_TEST);
	gl.enable(gl.BLEND);
        gl.drawArrays(gl.TRIANGLE_FAN, 0, 4);
    }

    function tick() {
        requestAnimFrame(tick, maincanvas);
        gl.useProgram(prog);
        gl.disable(gl.BLEND);
        gl.disable(gl.DEPTH_TEST);
        gl.viewport(0, 0, m, m);
	if (currentSamp==1) {
        gl.uniform1i(samp, 0);
        gl.bindFramebuffer(gl.FRAMEBUFFER, FBO1);
        gl.clear(gl.COLOR_BUFFER_BIT);
        gl.drawArrays(gl.TRIANGLE_FAN, 0, 4);
	gl.useProgram(prog_pic);
	gl.uniform1i(samp1_pic, 0);
	gl.uniform1i(samp2_pic, 2);
	gl.bindFramebuffer(gl.FRAMEBUFFER, picFBO1);
	gl.clear(gl.COLOR_BUFFER_BIT);
	gl.drawArrays(gl.TRIANGLE_FAN, 0, 4);
	currentSamp = 0;
	} else {
        gl.uniform1i(samp, 1);
        gl.bindFramebuffer(gl.FRAMEBUFFER, FBO);
        gl.clear(gl.COLOR_BUFFER_BIT);
        gl.drawArrays(gl.TRIANGLE_FAN, 0, 4);
	gl.useProgram(prog_pic);
	gl.uniform1i(samp1_pic, 1);
	gl.uniform1i(samp2_pic, 3);
	gl.bindFramebuffer(gl.FRAMEBUFFER, picFBO);
	gl.clear(gl.COLOR_BUFFER_BIT);
	gl.drawArrays(gl.TRIANGLE_FAN, 0, 4);
	currentSamp = 1;
	}
	drawScene();
    }

    function loadImage(url) {
	var imageObj = new Image();
	imageObj.onload = function() {
	invisibleCanvas.width=m;
	invisibleCanvas.height=m;
	var ctx = invisibleCanvas.getContext('2d');
        ctx.drawImage(imageObj, 0, 0, m, m);
	gl.viewport(0,0,m,m);
	gl.activeTexture(gl.TEXTURE2);
        gl.bindTexture(gl.TEXTURE_2D, pictexture);
        gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL, true);
        gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, ctx.getImageData(0, 0, m, m));
	//gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, m, m, 0,
        //gl.RGBA, gl.UNSIGNED_BYTE, ctx.getImageData(0,0,m,m));        
	gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);
        gl.activeTexture(gl.TEXTURE3);
        gl.bindTexture(gl.TEXTURE_2D, pictexture1);
        gl.pixelStorei(gl.UNPACK_ALIGNMENT, 1);
        //gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, ctx.getImageData(0, 0, m, m));
	gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, m, m, 0, gl.RGBA, gl.UNSIGNED_BYTE, null);        
	gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);
        gl.bindFramebuffer(gl.FRAMEBUFFER, picFBO1);
        gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0,
        gl.TEXTURE_2D, pictexture1, 0);
	gl.useProgram(prog_show);
	gl.uniform1i(samp_show, 2);
	gl.clear(gl.COLOR_BUFFER_BIT);
	gl.drawArrays(gl.TRIANGLE_FAN, 0, 4);
	
	gl.activeTexture(gl.TEXTURE2);
	gl.bindTexture(gl.TEXTURE_2D, pictexture);
	gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, m, m, 0, gl.RGBA, gl.UNSIGNED_BYTE, null);
	gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);
        gl.bindFramebuffer(gl.FRAMEBUFFER, picFBO);
        gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0,
        gl.TEXTURE_2D, pictexture, 0);
	gl.uniform1i(samp_show, 3);
	gl.clear(gl.COLOR_BUFFER_BIT);
	gl.drawArrays(gl.TRIANGLE_FAN, 0, 4);
        };
	imageObj.src = url;
    }

    var maincanvas;

    function webGLStart() {
        maincanvas = document.getElementById("example");
        gl = WebGLUtils.setupWebGL(maincanvas);
	maincanvas.width = maincanvas.clientWidth;
	maincanvas.height = maincanvas.clientHeight;
	invisibleCanvas = document.createElement("canvas");
        initShaders();
	loadImage('test.jpg');
        gl.clearColor(0.0, 0.0, 0.0, 1.0);
	gl.clearDepth(100);

        tick();
    }
		
</script>
</head>

<body onload="webGLStart()">
<canvas id="example"></canvas>
</body>
<script src="webgl-utils.js"></script>
